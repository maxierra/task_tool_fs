<!DOCTYPE html>
<html lang="es">
<head>
    <base href="">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Análisis de Casos Rechazados por Mambu - Versión Mejorada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .top-right-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .top-right-container textarea {
            width: 100%;
            height: 80px;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
        }
        .case-container {
            display: flex;
            margin-bottom: 3rem;
            margin-top: 120px;
        }
        .textarea-container {
            width: 250px;
            margin-right: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .textarea-container textarea {
            width: 100%;
            height: 120px;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
        }
        .case {
            flex-grow: 1;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 2rem;
            max-height: 700px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .case-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 0.5rem;
        }
        .case-description {
            background-color: #e9ecef;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        .table-cell-short {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .table-cell-expanded {
            white-space: normal;
            max-width: none;
        }
        .second-table-title {
            font-weight: bold;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: #198754;
        }
        .third-table-title {
            font-weight: bold;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: #dc3545;
        }
        .first-table {
            background-color: #e7f1ff;
            color: #0d6efd;
        }
        .first-table th {
            background-color: #0d6efd;
            color: white;
        }
        .first-table td {
            border-color: #b6d4fe;
        }
        .second-table {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .second-table th {
            background-color: #198754;
            color: white;
        }
        .second-table td {
            border-color: #badbcc;
        }
        .third-table {
            background-color: #f8d7da;
            color: #721c24;
        }
        .third-table th {
            background-color: #dc3545;
            color: white;
        }
        .third-table td {
            border-color: #f5c6cb;
        }
        .btn-copy {
            margin-top: 1rem;
        }
        .title-center {
            text-align: center;
            color: #0d6efd;
            font-weight: bold;
            font-size: 2.5rem;
            margin-bottom: 3rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-success {
            background-color: #198754;
            border-color: #198754;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
    </style>
</head>
<body>
    <%- include('navbar') %>
    <div class="top-right-container">
        <label for="inputData" class="form-label"><i class="fas fa-paste"></i> Pegue sus datos aquí:</label>
        <textarea id="inputData" class="form-control" placeholder="Pegue sus datos aquí..."></textarea>
        <button onclick="generateTables()" class="btn btn-primary btn-sm mt-2 w-100">
            <i class="fas fa-table"></i> Generar Tablas
        </button>
        <button onclick="copyToClipboard()" class="btn btn-success btn-sm mt-2 w-100">
            <i class="fas fa-copy"></i> Copiar Todo al Portapapeles
        </button>
    </div>

    <div class="container-fluid">
        <h1 class="title-center">
            <i class="fas fa-chart-bar"></i> Análisis de Casos Rechazados por Mambu
        </h1>
        <div id="tableContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const secondTableHeaders = [
            "Cuenta Desde", "Adicional", "Número Tarjeta", "Fecha", "Importe",
            "Moneda", "Importe Confirmado", "Internacional", "Importe Original",
            "Moneda Original", "Plan", "Cuotas", "Código Autorización",
            "Número Comercio", "Estado", "Fecha Estado", "Relacionada",
            "Nro Cupón", "Origen", "Rechazo", "ICA", "MCC", "TCC",
            "Regla Fraude", "Modo Entrada", "Terminal POS", "Stand-In",
            "Id Autorización", "Estado de la Autorización del POS",
            "Id Transaccion - Marca"
        ];

        const thirdTableHeaders = [
            "FILEPROCEFECHA", "DE3", "DE4", "DE6", "DE24", "DE25", "DE38", "DE43",
            "DE49", "DE51", "DE63", "AUTOVISATID", "CUENTA", "AUTOCODI", "AUTOFECHA",
            "CONSUFECHA", "CONSUIMPOR", "AUTOIMPOR", "ORIGEN", "DIFERENCIA", "A_MAMBU",
            "RELA_OK", "ONL_OK", "EXISTE_CRM", "RECH_MAMBU"
        ];

        function generateTables() {
            const data = document.getElementById('inputData').value;
            const lines = data.split('\n');
            const tableContainer = document.getElementById('tableContainer');
            let content = '';
            let caseNumber = 1;

            lines.forEach(line => {
                const columns = line.split('\t');
                if (columns.length >= 9) {
                    const depositAccountId = columns[6].trim();
                    const amount = columns[7].trim();

                    content += `
                        <div class="case-container" id="case${caseNumber}">
                            <div class="textarea-container">
                                <textarea id="case${caseNumber}TextAreaSecond" class="form-control" placeholder="Pegue los datos de la segunda tabla aquí..."></textarea>
                                <button onclick="updateSecondTable(${caseNumber})" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-sync-alt"></i> Actualizar Segunda Tabla
                                </button>
                                <textarea id="case${caseNumber}TextAreaThird" class="form-control mt-2" placeholder="Pegue los datos de la tercera tabla aquí..."></textarea>
                                <button onclick="updateThirdTable(${caseNumber})" class="btn btn-danger btn-sm mt-2">
                                    <i class="fas fa-sync-alt"></i> Actualizar Tercera Tabla
                                </button>
                            </div>
                            <div class="case">
                                <div class="case-title">
                                    <i class="fas fa-file-alt"></i> Caso ${caseNumber}
                                </div>
                                <div class="case-description">
                                    <strong><i class="fas fa-id-card"></i> DEPOSITACCOUNTID:</strong> ${depositAccountId}<br>
                                    <strong><i class="fas fa-dollar-sign"></i> AMOUNT:</strong> ${amount}<br>
                                    <strong><i class="fas fa-info-circle"></i> Descripción:</strong> [Ingrese la descripción]
                                </div>
                                <div class="table-container">
                                    <table class="table table-bordered table-striped table-hover first-table">
                                        <thead>
                                            <tr>
                                                <th>REQUESTMESSAGECOMPLETE</th>
                                                <th>RESULTMESSAGECOMPLETE</th>
                                                <th>ERRORCODE</th>
                                                <th>ERRORSOURCE</th>
                                                <th>ERRORREASON</th>
                                                <th>BIN</th>
                                                <th>DEPOSITACCOUNTID</th>
                                                <th>AMOUNT</th>
                                                <th>VISATID</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                ${columns.map(column => `<td class="table-cell-short" onclick="toggleExpand(this)">${column.trim()}</td>`).join('')}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="second-table-title">
                                    <i class="fas fa-table"></i> Segunda Tabla para el Caso ${caseNumber}
                                </div>
                                <div class="table-container">
                                    <table id="secondTable${caseNumber}" class="table table-bordered table-striped table-hover second-table">
                                        <thead>
                                            <tr>
                                                ${secondTableHeaders.map(header => `<th>${header}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                ${secondTableHeaders.map(() => `<td>[Ingrese datos]</td>`).join('')}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="third-table-title">
                                    <i class="fas fa-table"></i> Tercera Tabla para el Caso ${caseNumber}
                                </div>
                                <div class="table-container">
                                    <table id="thirdTable${caseNumber}" class="table table-bordered table-striped table-hover third-table">
                                        <thead>
                                            <tr>
                                                ${thirdTableHeaders.map(header => `<th>${header}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                ${thirdTableHeaders.map(() => `<td>[Ingrese datos]</td>`).join('')}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                    caseNumber++;
                }
            });

            tableContainer.innerHTML = content;
        }

        function updateSecondTable(caseNumber) {
            const textArea = document.getElementById(`case${caseNumber}TextAreaSecond`);
            const secondTable = document.getElementById(`secondTable${caseNumber}`);
            const data = textArea.value.trim();

            if (data) {
                const rows = data.split('\n');
                const tbody = secondTable.querySelector('tbody');
                tbody.innerHTML = '';

                rows.forEach(row => {
                    const columns = row.split('\t');
                    if (columns.length === secondTableHeaders.length) {
                        let rowHtml = '<tr>';
                        columns.forEach(column => {
                            rowHtml += `<td class="table-cell-short" onclick="toggleExpand(this)">${column.trim()}</td>`;
                        });
                        rowHtml += '</tr>';
                        tbody.innerHTML += rowHtml;
                    }
                });
            }
        }

        function updateThirdTable(caseNumber) {
            const textArea = document.getElementById(`case${caseNumber}TextAreaThird`);
            const thirdTable = document.getElementById(`thirdTable${caseNumber}`);
            const data = textArea.value.trim();

            if (data) {
                const rows = data.split('\n');
                const tbody = thirdTable.querySelector('tbody');
                tbody.innerHTML = '';

                rows.forEach(row => {
                    const columns = row.split('\t');
                    if (columns.length === thirdTableHeaders.length) {
                        let rowHtml = '<tr>';
                        columns.forEach(column => {
                            rowHtml += `<td class="table-cell-short" onclick="toggleExpand(this)">${column.trim()}</td>`;
                        });
                        rowHtml += '</tr>';
                        tbody.innerHTML += rowHtml;
                    }
                });
            }
        }

        function toggleExpand(cell) {
            cell.classList.toggle('table-cell-short');
            cell.classList.toggle('table-cell-expanded');
        }

        function copyToClipboard() {
            const tableContainer = document.getElementById('tableContainer');
            const range = document.createRange();
            range.selectNode(tableContainer);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                document.execCommand('copy');
                alert('¡Contenido copiado al portapapeles!');
            } catch (err) {
                console.error('No se pudo copiar el texto', err);
            }

            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
